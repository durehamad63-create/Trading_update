<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading AI Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f1419;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 428px;
            margin: 0 auto;
            background: #1a1f2e;
            min-height: 100vh;
            position: relative;
        }

        /* Header */
        .header {
            padding: 50px 20px 20px;
            background: linear-gradient(180deg, #1a1f2e 0%, #151a26 100%);
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 20px;
            color: #8a8f98;
        }

        .welcome {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .welcome-text h3 {
            font-size: 14px;
            color: #8a8f98;
            font-weight: 400;
        }

        .welcome-text h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 8px 16px;
            border-radius: 20px;
            background: #252d3d;
            border: none;
            color: #8a8f98;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab.active {
            background: #00d4aa;
            color: #1a1f2e;
            font-weight: 600;
        }

        /* Trending Section */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .see-all {
            color: #00d4aa;
            font-size: 14px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* Asset Card */
        .asset-card {
            background: #252d3d;
            margin: 0 20px 15px;
            padding: 15px;
            border-radius: 16px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .asset-card:active {
            transform: scale(0.98);
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .asset-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .asset-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .asset-icon.btc {
            background: linear-gradient(135deg, #f7931a 0%, #ff6b00 100%);
        }

        .asset-icon.eth {
            background: linear-gradient(135deg, #627eea 0%, #4e5d94 100%);
        }

        .asset-icon.rev {
            background: linear-gradient(135deg, #e91e63 0%, #9c27b0 100%);
        }

        .asset-name h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .asset-name p {
            font-size: 13px;
            color: #8a8f98;
        }

        .change-badge {
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .change-badge.up {
            background: rgba(0, 212, 170, 0.15);
            color: #00d4aa;
        }

        .change-badge.down {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .asset-details {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
        }

        .detail-item {
            flex: 1;
        }

        .detail-label {
            color: #8a8f98;
            margin-bottom: 4px;
        }

        .detail-value {
            font-weight: 600;
        }

        .detail-value.up {
            color: #00d4aa;
        }

        .detail-value.down {
            color: #ef4444;
        }

        /* Detail View */
        .detail-view {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1f2e;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s;
            overflow-y: auto;
        }

        .detail-view.active {
            transform: translateX(0);
        }

        .detail-header {
            padding: 50px 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .back-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #252d3d;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .favorite-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #252d3d;
            border: none;
            color: #8a8f98;
            font-size: 20px;
            cursor: pointer;
        }

        .detail-asset-info {
            text-align: center;
            padding: 20px;
        }

        .detail-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .detail-change {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }

        .chart-container {
            padding: 20px;
            background: #252d3d;
            margin: 20px;
            border-radius: 16px;
        }

        .chart-legend {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .legend-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .legend-dot.past {
            background: #627eea;
        }

        .legend-dot.future {
            background: #00d4aa;
        }

        .chart-price {
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .chart-wrapper {
            height: 200px;
            position: relative;
        }

        .timeframe-tabs {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            justify-content: center;
        }

        .timeframe-tab {
            padding: 8px 16px;
            border-radius: 20px;
            background: #1a1f2e;
            border: none;
            color: #8a8f98;
            font-size: 13px;
            cursor: pointer;
        }

        .timeframe-tab.active {
            background: #00d4aa;
            color: #1a1f2e;
            font-weight: 600;
        }

        .chart-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }

        .chart-action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            border-radius: 20px;
            background: #1a1f2e;
            border: none;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
        }

        .forecast-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
        }

        .info-card {
            background: #252d3d;
            padding: 15px;
            border-radius: 12px;
        }

        .info-label {
            font-size: 13px;
            color: #8a8f98;
            margin-bottom: 8px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
        }

        .info-value.up {
            color: #00d4aa;
        }

        .refresh-btn {
            margin: 20px;
            width: calc(100% - 40px);
            padding: 15px;
            border-radius: 25px;
            background: #252d3d;
            border: none;
            color: #fff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 428px;
            width: 100%;
            background: #1a1f2e;
            padding: 15px 20px 25px;
            display: flex;
            justify-content: space-around;
            border-top: 1px solid #252d3d;
        }

        .nav-item {
            background: none;
            border: none;
            color: #8a8f98;
            font-size: 24px;
            cursor: pointer;
            padding: 10px;
            transition: color 0.3s;
        }

        .nav-item.active {
            color: #00d4aa;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8a8f98;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main View -->
        <div id="mainView">
            <div class="header">
                <div class="status-bar">
                    <span id="currentTime">9:41</span>
                    <span>üì∂ üì° üîã</span>
                </div>
                <div class="welcome">
                    <div class="welcome-text">
                        <h3>Welcome!</h3>
                        <h1>Hi Umar!</h1>
                    </div>
                    <div class="avatar">üë§</div>
                </div>
                <div class="tabs">
                    <button class="tab active" data-class="all">All</button>
                    <button class="tab" data-class="stocks">Stocks</button>
                    <button class="tab" data-class="crypto">Crypto</button>
                    <button class="tab" data-class="macro">Macro</button>
                </div>
            </div>

            <div class="section-header">
                <span>Trending</span>
                <a href="#" class="see-all">see all ‚Üí</a>
            </div>

            <div id="assetList" class="loading">Loading market data...</div>
        </div>

        <!-- Detail View -->
        <div id="detailView" class="detail-view">
            <div class="detail-header">
                <button class="back-btn" onclick="closeDetail()">‚Üê</button>
                <h2 id="detailTitle">Asset</h2>
                <button class="favorite-btn">‚ô°</button>
            </div>

            <div class="detail-asset-info">
                <div id="detailIcon" class="detail-icon"></div>
                <div id="detailChange" class="detail-change"></div>
            </div>

            <div class="chart-container">
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-dot past"></span>
                        <span>Past</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-dot future"></span>
                        <span>Future</span>
                    </div>
                </div>
                <div class="chart-price" id="chartPrice">$0.00</div>
                <div class="chart-wrapper">
                    <canvas id="priceChart"></canvas>
                </div>
                <div class="timeframe-tabs">
                    <button class="timeframe-tab active" data-timeframe="1D">1D</button>
                    <button class="timeframe-tab" data-timeframe="7D">7D</button>
                    <button class="timeframe-tab" data-timeframe="1M">1M</button>
                    <button class="timeframe-tab" data-timeframe="1Y">1Y</button>
                    <button class="timeframe-tab" data-timeframe="5Y">5Y</button>
                </div>
                <div class="chart-actions">
                    <button class="chart-action-btn">üíæ Save</button>
                    <button class="chart-action-btn" onclick="refreshChart()">üîÑ Refresh</button>
                </div>
            </div>

            <div class="forecast-info">
                <div class="info-card">
                    <div class="info-label">Forecast Direction</div>
                    <div id="forecastDirection" class="info-value up">‚Üë UP</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Confidence Score</div>
                    <div id="confidenceScore" class="info-value">86%</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Predicted</div>
                    <div id="predictedPrice" class="info-value">$0.00</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Last Updated</div>
                    <div id="lastUpdated" class="info-value">--</div>
                </div>
            </div>

            <button class="refresh-btn" onclick="refreshChart()">üîÑ Refresh</button>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-item active">üè†</button>
            <button class="nav-item">üìä</button>
            <button class="nav-item">üí¨</button>
            <button class="nav-item">‚ô°</button>
            <button class="nav-item">‚öôÔ∏è</button>
        </div>
    </div>

    <script>
        const API_BASE = 'https://lavish-peace-production.up.railway.app';
        const DEBUG = true;
        
        function log(message, data) {
            if (DEBUG) {
                console.log(`[Trading UI] ${message}`, data || '');
            }
        }
        let currentSymbol = null;
        let currentTimeframe = '1D';
        let ws = null;
        let chart = null;

        // Update time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = 
                now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Load market summary
        async function loadMarketSummary(assetClass = 'all') {
            const listEl = document.getElementById('assetList');
            listEl.innerHTML = '<div class="loading">Loading market data...</div>';

            try {
                const url = assetClass === 'all' 
                    ? `${API_BASE}/api/market/summary?limit=20`
                    : `${API_BASE}/api/market/summary?class=${assetClass}&limit=20`;
                
                log('Fetching market summary', url);
                const response = await fetch(url);
                log('Response status', response.status);
                if (!response.ok) throw new Error('API request failed');
                
                const data = await response.json();
                log('Market data received', { total: data.assets?.length, assets: data.assets });
                
                if (!data.assets || data.assets.length === 0) {
                    listEl.innerHTML = '<div class="error">No assets available</div>';
                    return;
                }

                listEl.innerHTML = data.assets.map(asset => `
                    <div class="asset-card" onclick="openDetail('${asset.symbol}')">
                        <div class="asset-header">
                            <div class="asset-info">
                                <div class="asset-icon ${asset.symbol.toLowerCase()}">
                                    ${getAssetIcon(asset.symbol)}
                                </div>
                                <div class="asset-name">
                                    <h3>${asset.symbol}</h3>
                                    <p>${asset.name}</p>
                                </div>
                            </div>
                            <div class="change-badge ${asset.change_24h >= 0 ? 'up' : 'down'}">
                                ${asset.change_24h >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(asset.change_24h).toFixed(2)}%
                            </div>
                        </div>
                        <div class="asset-details">
                            <div class="detail-item">
                                <div class="detail-label">Forecast</div>
                                <div class="detail-value ${asset.forecast_direction === 'UP' ? 'up' : asset.forecast_direction === 'DOWN' ? 'down' : ''}">
                                    ${asset.forecast_direction === 'UP' ? '‚Üë' : asset.forecast_direction === 'DOWN' ? '‚Üì' : '‚Üí'} ${asset.forecast_direction}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Confidence</div>
                                <div class="detail-value">${asset.confidence}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Predicted</div>
                                <div class="detail-value">${formatPrice(asset.predicted_price, asset.symbol)}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                log('Market summary error', error);
                listEl.innerHTML = `<div class="error">Failed to load data: ${error.message}<br>Make sure API is running on ${API_BASE}</div>`;
            }
        }

        function getAssetIcon(symbol) {
            const icons = {
                'BTC': '‚Çø', 'ETH': 'Œû', 'BNB': 'B', 'SOL': '‚óé', 'ADA': '‚Ç≥',
                'XRP': 'X', 'DOGE': '√ê', 'USDT': '$', 'USDC': '$', 'TRX': 'T',
                'NVDA': 'üéÆ', 'MSFT': 'ü™ü', 'AAPL': 'üçé', 'GOOGL': 'G', 'AMZN': 'üì¶',
                'META': 'M', 'AVGO': 'A', 'TSLA': 'üöó', 'BRK-B': 'B', 'JPM': 'J',
                'GDP': 'üí∞', 'CPI': 'üìä', 'UNEMPLOYMENT': 'üë•', 'FED_RATE': 'üè¶', 'CONSUMER_CONFIDENCE': 'üòä'
            };
            return icons[symbol] || symbol[0];
        }

        function formatPrice(price, symbol) {
            if (['GDP'].includes(symbol)) return `$${(price/1000).toFixed(1)}T`;
            if (['CPI', 'CONSUMER_CONFIDENCE'].includes(symbol)) return price.toFixed(1);
            if (['UNEMPLOYMENT', 'FED_RATE'].includes(symbol)) return `${price.toFixed(2)}%`;
            if (price >= 1000) return `$${(price/1000).toFixed(2)}k`;
            if (price >= 1) return `$${price.toFixed(2)}`;
            return `$${price.toFixed(4)}`;
        }

        // Open detail view
        function openDetail(symbol) {
            log('Opening detail view', symbol);
            currentSymbol = symbol;
            document.getElementById('detailView').classList.add('active');
            document.getElementById('detailTitle').textContent = symbol;
            document.getElementById('detailIcon').innerHTML = getAssetIcon(symbol);
            document.getElementById('detailIcon').className = `detail-icon ${symbol.toLowerCase()}`;
            
            loadChartData(symbol, currentTimeframe);
            connectWebSocket(symbol, currentTimeframe);
        }

        function closeDetail() {
            document.getElementById('detailView').classList.remove('active');
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        // Load chart data
        async function loadChartData(symbol, timeframe) {
            try {
                const url = `${API_BASE}/api/asset/${symbol}/forecast?timeframe=${timeframe}`;
                log('Loading chart data', url);
                const response = await fetch(url);
                log('Chart response status', response.status);
                if (!response.ok) throw new Error('Failed to load chart data');
                
                const data = await response.json();
                log('Chart data received', data);
                
                document.getElementById('chartPrice').textContent = formatPrice(data.current_price, symbol);
                document.getElementById('detailChange').innerHTML = `
                    ${data.change_24h >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(data.change_24h).toFixed(2)}%
                `;
                document.getElementById('detailChange').className = `detail-change ${data.change_24h >= 0 ? 'up' : 'down'}`;
                
                document.getElementById('forecastDirection').innerHTML = 
                    `${data.forecast_direction === 'UP' ? '‚Üë' : data.forecast_direction === 'DOWN' ? '‚Üì' : '‚Üí'} ${data.forecast_direction}`;
                document.getElementById('forecastDirection').className = 
                    `info-value ${data.forecast_direction === 'UP' ? 'up' : data.forecast_direction === 'DOWN' ? 'down' : ''}`;
                document.getElementById('confidenceScore').textContent = `${data.confidence}%`;
                document.getElementById('predictedPrice').textContent = formatPrice(data.predicted_price, symbol);
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

                if (data.chart && data.chart.actual && data.chart.predicted) {
                    renderChart(data.chart);
                }
            } catch (error) {
                log('Chart load error', error);
                console.error('Chart load error:', error);
            }
        }

        // Render chart
        function renderChart(chartData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (chart) chart.destroy();

            const actualData = chartData.actual.slice(-30);
            const predictedData = chartData.predicted.slice(-10);
            const labels = chartData.timestamps.slice(-30).map(t => {
                const date = new Date(t);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Past',
                            data: actualData,
                            borderColor: '#627eea',
                            backgroundColor: 'rgba(98, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0
                        },
                        {
                            label: 'Future',
                            data: [...Array(actualData.length - predictedData.length).fill(null), ...predictedData],
                            borderColor: '#00d4aa',
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#252d3d',
                            titleColor: '#fff',
                            bodyColor: '#8a8f98',
                            borderColor: '#00d4aa',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: false
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // WebSocket connection
        function connectWebSocket(symbol, timeframe) {
            if (ws) {
                log('Closing existing WebSocket');
                ws.close();
            }

            const wsUrl = `wss://lavish-peace-production.up.railway.app/ws/chart/${symbol}?timeframe=${timeframe}`;
            log('Connecting WebSocket', wsUrl);
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                log('WebSocket connected', symbol);
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                log('WebSocket message', { type: data.type, symbol });
                
                if (data.type === 'chart_update' && data.chart) {
                    document.getElementById('chartPrice').textContent = formatPrice(data.current_price, symbol);
                    document.getElementById('detailChange').innerHTML = `
                        ${data.change_24h >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(data.change_24h).toFixed(2)}%
                    `;
                    document.getElementById('detailChange').className = `detail-change ${data.change_24h >= 0 ? 'up' : 'down'}`;
                    document.getElementById('forecastDirection').innerHTML = 
                        `${data.forecast_direction === 'UP' ? '‚Üë' : data.forecast_direction === 'DOWN' ? '‚Üì' : '‚Üí'} ${data.forecast_direction}`;
                    document.getElementById('forecastDirection').className = 
                        `info-value ${data.forecast_direction === 'UP' ? 'up' : data.forecast_direction === 'DOWN' ? 'down' : ''}`;
                    document.getElementById('confidenceScore').textContent = `${data.confidence}%`;
                    document.getElementById('predictedPrice').textContent = data.predicted_range || formatPrice(data.current_price, symbol);
                    document.getElementById('lastUpdated').textContent = new Date(data.last_updated).toLocaleString();
                    
                    renderChartFromWebSocket(data.chart);
                }
            };

            ws.onclose = (event) => {
                log('WebSocket closed', { code: event.code, reason: event.reason });
            };
            
            ws.onerror = (error) => {
                log('WebSocket error', error);
                console.error('WebSocket error:', error);
            };
        }

        function renderChartFromWebSocket(chartData) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            if (chart) chart.destroy();

            const pastData = chartData.past || [];
            const futureData = chartData.future || [];
            const timestamps = chartData.timestamps || [];
            
            const labels = timestamps.map(t => {
                const date = new Date(t);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Past',
                            data: [...pastData, ...Array(futureData.length).fill(null)],
                            borderColor: '#627eea',
                            backgroundColor: 'rgba(98, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0
                        },
                        {
                            label: 'Future',
                            data: [...Array(pastData.length).fill(null), ...futureData],
                            borderColor: '#00d4aa',
                            backgroundColor: 'rgba(0, 212, 170, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#252d3d',
                            titleColor: '#fff',
                            bodyColor: '#8a8f98',
                            borderColor: '#00d4aa',
                            borderWidth: 1
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        function refreshChart() {
            if (currentSymbol) {
                loadChartData(currentSymbol, currentTimeframe);
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                loadMarketSummary(tab.dataset.class);
            });
        });

        // Timeframe switching via WebSocket message
        document.querySelectorAll('.timeframe-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.timeframe-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentTimeframe = tab.dataset.timeframe;
                
                if (ws && ws.readyState === WebSocket.OPEN) {
                    // Send timeframe change via WebSocket
                    const message = {
                        type: 'change_timeframe',
                        timeframe: currentTimeframe
                    };
                    ws.send(JSON.stringify(message));
                    log('Sent timeframe change', message);
                } else if (currentSymbol) {
                    // Fallback: reconnect with new timeframe
                    loadChartData(currentSymbol, currentTimeframe);
                    connectWebSocket(currentSymbol, currentTimeframe);
                }
            });
        });

        // Initial load
        loadMarketSummary('all');
    </script>
</body>
</html>
